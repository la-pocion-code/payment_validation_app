{% extends 'records/base.html' %}

{% block title %}Historial de Intentos de Duplicados{% endblock %}

{% block content %}
    <h2>Historial de Intentos de Registros Duplicados</h2>

    <form method="get" class="filter-form">
        <div class="filter-fields">
            {% for field in filter.form %}
                <div class="filter-field">
                    {{ field.label_tag }}
                    {{ field }}
                </div>
            {% endfor %}
        </div>
        <div class="filter-actions">
            <button type="submit">Filtrar</button>
            <a href="{% url 'export_duplicate_attempts_csv' %}?{{ request.GET.urlencode }}">Descargar CSV</a>
        </div>
    </form>

    <br>

    <table border="1">
        <thead>
            <tr>
                <th>Usuario (Intento)</th>
                <th>Fecha y Hora (Intento)</th>
                <th>Datos del Intento</th>
                <th>Resuelto por</th>
                <th>Fecha y Hora (Resuelto)</th>
                <th>Estado</th>
            </tr>
        </thead>
        <tbody>
            {% for attempt in filter.qs %}
            <tr>
                <td>{{ attempt.user.username }}</td>
                <td>{{ attempt.timestamp|date:"d/m/Y H:i:s" }}</td>
                <td>
                    <ul>
                        {% for key, value in attempt.data.items %}
                            <li><strong>{{ key }}:</strong> {{ value }}</li>
                        {% endfor %}
                    </ul>
                </td>
                <td>{{ attempt.resolved_by.username|default:"N/A" }}</td>
                <td>{{ attempt.resolved_at|date:"d/m/Y H:i:s"|default:"N/A" }}</td>
                <td>{% if attempt.is_resolved %}Resuelto{% else %}Pendiente{% endif %}</td>
            </tr>
            {% empty %}
            <tr><td colspan="4">No hay intentos de registros duplicados.</td></tr>
            {% endfor %}
        </tbody>
    </table>

    {% if is_paginated %}
      <div>
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}">Anterior</a>
        {% endif %}
        <span>PÃ¡gina {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}">Siguiente</a>
        {% endif %}
      </div>
    {% endif %}
{% endblock %}
