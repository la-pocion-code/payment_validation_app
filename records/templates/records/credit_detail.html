{% extends 'records/base.html' %}
{% load humanize %}
{% load static %}

{% block title %}Detalle de recibo{% endblock %}

{% block content %}
    {% csrf_token %}
    {% if client %}
    <div class="detail-section">
        <h3>Información del Cliente</h3>
        <p><strong>Nombre:</strong> {{ client.name }}</p>
        <p><strong>DNI:</strong> {{ client.dni }}</p>
        <p><strong>Saldo a Favor:</strong> ${{ client.available_balance|intcomma }}</p> 
    </div>
    {% endif %}
    <h2>Detalle de recibo #{{ credit.id }}</h2>
    <h3>Información del Abono</h3>
     <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Cliente</th>
                            <th>Fecha de Recibo</th>
                            <th>Hora</th>
                            <th>Comprobante</th>
                            <th>Banco Llegada</th>
                            <th>Valor</th>
                            <th>Origen Transacción</th>                  
                            <th>Estado</th>
                        
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            {% if user.is_superuser %}
                                <td {% if credit.transaction %}
                                        data-bs-toggle="tooltip"
                                        title="No se puede cambiar el cliente de un recibo asociado a una transacción."
                                    {% endif %}>
                                    {% if credit.transaction %}
                                        <span class="text-muted">{{ credit.display_client }}</span>
                                    {% else %}
                                        <input type="text"
                                            id="client-autocomplete"
                                            class="form-control"
                                            value="{{ credit.display_client.name|default:'SIN ASIGNAR' }}"
                                            data-credit-id="{{ credit.pk }}">

                                        <!-- Campo oculto para guardar el ID del cliente seleccionado -->
                                        <input type="hidden" id="selected-client-id" value="{{ credit.display_client.pk|default:'' }}">
                                    {% endif %}
                                </td>
                              <td class="editable-cell" contenteditable="true" data-credit-id="{{ credit.pk }}" data-field="fecha">{{ credit.fecha|date:"d/m/Y" }}</td>
                                <td class="editable-cell" contenteditable="true" data-credit-id="{{ credit.pk }}" data-field="hora">{{ credit.hora|time:"H:i:s" }}</td>
                                <td class="editable-cell" contenteditable="true" data-credit-id="{{ credit.pk }}" data-field="comprobante">{{ credit.comprobante }}</td>
                                <td>
                                    <div class="editable-container">
                                        <select name="banco_llegada" data-credit-id="{{ credit.pk }}" data-field="banco_llegada"
                                                class="form-select badge-select editable-field bg-light text-dark">
                                            {% for bank in banks %}
                                                <option value="{{ bank.pk }}" {% if credit.banco_llegada.pk == bank.pk %}selected{% endif %}>
                                                    {{ bank.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </td>
                                <td class="editable-cell" contenteditable="true" data-credit-id="{{ credit.pk }}" data-field="valor">${{ credit.valor|intcomma }}</td>
                                <td>
                                    <div class="editable-container" style="position: relative; z-index: 10;">
                                        <select name="origen_transaccion"
                                                data-credit-id="{{ credit.pk }}"
                                                data-field="origen_transaccion"
                                                class="form-select badge-select editable-field bg-light text-dark">

                                            {% for origen in origenes %}
                                                <option value="{{ origen.pk }}" {% if credit.origen_transaccion.pk == origen.pk %}selected{% endif %}>
                                                    {{ origen.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </td>
                            {% else %}
                                <td>{{ credit.fecha|date:"d/m/Y" }}</td>
                                <td>{{ credit.hora|time:"H:i:s" }}</td>
                                <td>{{ credit.comprobante }}</td>
                                <td>{{ credit.banco_llegada.name }}</td>
                                <td>${{ credit.valor|intcomma }}</td>
                                <td>{{ credit.origen_transaccion.name }}</td>
                            {% endif %}
                            <td>
                                {% if user.is_superuser or 'Validador' in user_groups %}
                                    <div class="editable-container">
                                        <select name="payment_status" data-credit-id="{{ credit.pk }}" data-field="payment_status" class="form-select badge-select editable-field {% if credit.payment_status == 'Aprobado' %}bg-success{% elif credit.payment_status == 'Rechazado' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                            {% for key, value in credit.APROVED_CHOICES %}
                                                <option value="{{ key }}" {% if credit.payment_status == key %}selected{% endif %}>
                                                    {{ value }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                {% else %}
                                    <span class="badge {% if credit.payment_status == 'Aprobado' %}bg-success{% elif credit.payment_status == 'Rechazado' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                        {{ credit.get_payment_status_display }}
                                    </span>
                                {% endif %}
                            </td>
                        </tr>     
                    </tbody>
                </table>
                <div id="feedback-container" class="mt-2"></div>
            </div>
        </div>
    </div>

    <div class="card mt-4 mb-4">
        <div class="card-header">
            <h5>Nota</h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                {{ note_form.note }}
                <button type="submit" class="btn btn-primary mt-2">Guardar Nota</button>
            </form>
        </div>
    </div>
  

    <h3>Historial de Cambios del Abono</h3>
    {% if history %}
        <table class="history-table" border="1">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Tipo</th>
                    <th>Cambios</th>
                </tr>
            </thead>
            <tbody>
                {% for record in history %}
                    <tr>
                        <td>{{ record.history_date|date:"d/m/Y H:i" }}</td>
                        <td>{{ record.history_user|default:"Sistema" }}</td>
                        <td>{{ record.get_history_type_display }}</td>
                        <td>
                            {% if record.history_type == '~' and record.delta %}
                                <ul>
                                {% for change in record.delta.changes %}
                                    <li>
                                        <strong>{{ change.field|capfirst }}:</strong>
                                        de <em>{{ change.old }}</em> a <em>{{ change.new }}</em>
                                    </li>
                                {% endfor %}
                                </ul>
                            {% elif record.history_type == '+' %}
                                Creado
                            {% elif record.history_type == '-' %}
                                Eliminado
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No hay historial de cambios para este abono.</p>
    {% endif %}

    <div class="actions">
        <a href="{% url 'credit_list' %}" class="btn btn-secondary d-flex align-items-center">Atrás</a>
    </div>

<style>
    .detail-section { background-color: #f9f9f9; border: 1px solid #eee; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
    .detail-section h3 { margin-top: 0; color: #362573; }
    .detail-section p { margin-bottom: 5px; }
    .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .history-table th, .history-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    .history-table th { background-color: #e0e0e0; }
    .actions { margin-top: 20px; margin-bottom: 20px; display: flex; gap: 10px; }
    .badge-select { border: 0; padding: 0.5em 2.5em 0.5em 0.75em; font-size: 0.9em; font-weight: 700; line-height: 1; color: #fff; white-space: nowrap; vertical-align: baseline; border-radius: 0.25rem; cursor: pointer; background-position: right 0.75rem center; }
    .badge-select.bg-success { background-color: #198754 !important; color: white; }
    .badge-select.bg-danger { background-color: #dc3545 !important; color: white; }
    .badge-select.bg-warning { background-color: #ffc107 !important; color: black; }
    .feedback-message { padding: 8px; margin-top: 5px; border-radius: 4px; }
    .feedback-success { background-color: #d4edda; color: #155724; }
    .feedback-error { background-color: #f8d7da; color: #721c24; }
</style>

{% if user.is_superuser or 'Validador' in user_groups %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const feedbackContainer = document.getElementById('feedback-container');

    function showFeedback(message, isSuccess) {
        const feedbackDiv = document.createElement('div');
        feedbackDiv.textContent = message;
        feedbackDiv.className = isSuccess
            ? 'feedback-message feedback-success'
            : 'feedback-message feedback-error';

        feedbackContainer.innerHTML = '';
        feedbackContainer.appendChild(feedbackDiv);

        setTimeout(() => feedbackDiv.remove(), 4000);
    }

    function handleUpdate(creditId, field, value, element) {
        const url = `/records/credit/${creditId}/update_field/`;

        showFeedback(`Guardando cambio en "${element.dataset.field}"...`, true);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ field: field, value: value })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showFeedback(data.message || `Campo "${field}" actualizado correctamente.`, true);

                if (field === 'payment_status') {
                    element.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-dark');
                    if (value === 'Aprobado') element.classList.add('bg-success');
                    else if (value === 'Rechazado') element.classList.add('bg-danger');
                    else element.classList.add('bg-warning', 'text-dark');
                }
            } else {
                showFeedback(data.message || `Error al actualizar "${field}".`, false);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showFeedback('Error de red al intentar actualizar.', false);
        });
    }

    function handleClientUpdate(creditId, clientId) {
    // CORRECCIÓN: La URL correcta no lleva el prefijo '/records/'
        const url = `/credit/${creditId}/update_client/`; 
    
        showFeedback(`Reasignando recibo...`, true);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ client_id: clientId })
        })
        .then(response => {
            if (!response.ok) {
                // Si la respuesta no es 2xx, la convertimos en un error para que la capture el .catch
                return response.json().then(err => { throw err; });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showFeedback(data.message, true);

                const clientInfoDiv = document.querySelector('.detail-section');
                if (clientInfoDiv) {
                    clientInfoDiv.querySelector('p:nth-of-type(1)').innerHTML = `<strong>Nombre:</strong> ${`data.new_client_name`}`;
                    clientInfoDiv.querySelector('p:nth-of-type(2)').innerHTML = `<strong>DNI:</strong> ${`data.new_client_dni`}`;
                    clientInfoDiv.querySelector('p:nth-of-type(3)').innerHTML = `<strong>Saldo a Favor:</strong> $${`data.new_client_balance`}`;
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Usamos el mensaje de error del servidor si está disponible
            const errorMessage = error.message || 'Error de red al intentar reasignar el cliente.';
            showFeedback(errorMessage, false);
            setTimeout(() => location.reload(), 2000); 
        });
    }

    // Selects editables
    document.querySelectorAll('.editable-field').forEach(select => {
        select.addEventListener('change', function() {
            handleUpdate(this.dataset.creditId, this.dataset.field, this.value, this);
        });
    });

    // Celdas contenteditable
    document.querySelectorAll('.editable-cell').forEach(cell => {
        let originalValue = cell.textContent.trim();
        cell.addEventListener('blur', function() {
            const currentValue = this.textContent.trim();
            if (originalValue !== currentValue) {
                handleUpdate(this.dataset.creditId, this.dataset.field, currentValue, this);
                originalValue = currentValue;
            }
        });
    });

    // Select cliente
    const clientSelect = document.getElementById('client-select');
    if (clientSelect) {
        clientSelect.addEventListener('change', function() {
            handleClientUpdate(this.dataset.creditId, this.value);
        });
    }
    // Inicializar el widget de autocompletado de jQuery UI
    $('#client-autocomplete').autocomplete({
        source: "{% url 'client_search_ajax' %}", // URL de la vista de búsqueda
        minLength: 2, // Empezar a buscar después de 2 caracteres
        select: function(event, ui) {
            event.preventDefault(); // Prevenir el comportamiento por defecto

            // 1. Poner el nombre del cliente en el campo visible
            this.value = ui.item.label.split(' (')[0]; // Extrae solo el nombre

            // 2. Guardar el ID del cliente en el campo oculto
            $('#selected-client-id').val(ui.item.id);

            // 3. Obtener el ID del crédito desde el atributo data-*
            const creditId = $(this).data('credit-id');

            // 4. Llamar a nuestra función para actualizar el cliente en el backend
            handleClientUpdate(creditId, ui.item.id);
        },
        // Opcional: Si el usuario borra el campo, limpiar el ID oculto
        change: function(event, ui) {
            if (!ui.item) {
                this.value = '';
                $('#selected-client-id').val('');
            }
        }
    });
});


</script>

{% endif %}
{% endblock %}