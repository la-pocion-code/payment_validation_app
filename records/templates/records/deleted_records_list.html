{% extends 'records/base.html' %}

{% block title %}Registros Eliminados{% endblock %}

{% block content %}
    <h1>Registros Eliminados</h1>
    <a href="{% url 'record_list' %}">&larr; Volver a la lista</a>
    <hr>
    {% if deleted_records %}
        <table>
            <thead>
                <tr>
                    <th>Fecha de Eliminación</th>
                    <th>Eliminado por</th>
                    <th>Datos del Registro</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for record in deleted_records %}
                    <tr>
                        <td>{{ record.history_date }}</td>
                        <td>{{ record.history_user }}</td>
                        <td>{{ record.fecha|date:"d/m/Y" }} - {{ record.comprobante }} - {{ record.valor }}</td>
                        <td>
                            {% if user.is_superuser %}
                                <form action="{% url 'restore_receipt' record.history_id %}" method="post" style="display: inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="submit-btn">Restaurar</button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>No hay registros eliminados.</p>
    {% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const restoreForms = document.querySelectorAll('form[action*="restore_receipt"]');

    restoreForms.forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent normal form submission

            const url = this.action;
            const csrfToken = this.querySelector('input[name="csrfmiddlewaretoken"]').value;
            const row = this.closest('tr');

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    row.style.transition = 'opacity 0.5s ease';
                    row.style.opacity = '0';
                    setTimeout(() => {
                        row.remove();
                        const tbody = document.querySelector('table tbody');
                        if (tbody && tbody.children.length === 0) {
                            const colCount = row.children.length;
                            const emptyRow = `<tr><td colspan="${colCount}">No hay registros eliminados.</td></tr>`;
                            const table = tbody.closest('table');
                            table.insertAdjacentHTML('afterend', '<p>No hay registros eliminados.</p>');
                            table.remove();
                        }
                    }, 500);
                    
                    // Opcional: Mostrar una notificación más sutil en lugar de un alert
                    // Por ejemplo, usando una librería como Toastify o creando un div temporal.
                } else {
                    alert('Error al restaurar el recibo: ' + (data.message || 'Error desconocido.'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                let errorMessage = 'Ocurrió un error de red o del servidor.';
                if (error && error.message) {
                    errorMessage = error.message;
                }
                alert(errorMessage);
            });
        });
    });
});
</script>
{% endblock %}
