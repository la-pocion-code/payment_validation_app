{% extends 'records/base.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}


    <h2>{{ title }}</h2>
    <div class="d-flex justify-content-start mb-4">
        <div id="transaction-summary" 
             class="card shadow-sm"
             data-expected-amount="{{ transaction.expected_amount|stringformat:'f' }}"
             data-initial-receipts="{{ total_receipts_amount|stringformat:'f' }}">
            <div class="card-body p-2">
                <div class="d-flex align-items-center gap-4">
                    <div class="text-center px-2">
                        <small class="text-muted d-block">Monto Esperado</small>
                        <h5 id="expected-amount-display" class="mb-0 text-body-secondary">{{ transaction.expected_amount|floatformat:2 }}</h5>
                    </div>
                    <div class="text-center px-2">
                        <small class="text-muted d-block">Total Recibos</small>
                        <h5 id="total-receipts-display" class="mb-0 fw-bold">{{ total_receipts_amount|floatformat:2 }}</h5>
                    </div>
                    <div class="text-center px-2">
                        <small class="text-muted d-block">Diferencia</small>
                        <h5 id="transaction-difference-display" class="mb-0 fw-bold">{{ difference|floatformat:2 }}</h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

 
    {% if difference < 0 %}
        <div class="alert alert-warning d-flex justify-content-between align-items-center mt-3">
            <span>
                <strong>¡Pago en Exceso!</strong> Hay un excedente de <strong>${{ difference|floatformat:2 }}</strong> en esta transacción.
            </span>
            <form action="{% url 'create_credit_note_from_surplus' transaction.pk %}" method="post" onsubmit="return confirm('¿Estás seguro de que deseas generar una nota de crédito por el excedente? Esta acción creará un nuevo recibo de ajuste en esta transacción y un saldo a favor para el cliente.');">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Generar Nota de Crédito</button>
            </form>
        </div>
    {% endif %}

    <form method="post" id="transaction-form">
        {% csrf_token %}
        {# Transaction Form #}
        <fieldset>
            <legend>Detalles de la Transacción # {{ transaction.unique_transaction_id }}</legend>
            <table class="transaction-details-horizontal">
               
                <tbody>
                    <tr>
                        <th>Tipo Transacción</th>
                        <th>Fecha Transaccón</th>
                        <th>Cliente</th>
                        <th>Vendedor</th>
                        <th>Valor Venta</th>
                        <th>Observación</th>
                        <th>Facturador</th>
                        <th># de Factura</th>
                        <th>Estado Transacción</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        {# --- LOGICA DE PERMISOS PARA CAMPOS DE TRANSACCION --- #}
                        {# Admin: Todo editable #}
                        {# Digitador: Todo readonly #}
                        {# Validador: Todo readonly #}
                        {# Facturador: Solo 'status' y 'numero_factura' editables #}


                        {# 1. TIPO TRANSACCION #}
                        <td>
                            {% if is_admin %}
                                {{ form.transaction_type }}
                            {% else %}
                                <input type="text" class="form-control" value="{{ form.instance.transaction_type }}" readonly>
                                <input type="hidden" name="{{ form.transaction_type.name }}" value="{{ form.instance.transaction_type.id }}">
                            {% endif %}
                            {{ form.transaction_type.errors }}
                        </td>

                        {# 2. FECHA #}
                        <td>
                            {% if is_admin %}
                                <input type="date" name="{{ form.date.name }}" value="{{ form.instance.date|date:'Y-m-d' }}" class="form-control" id="{{ form.date.id_for_label }}">
                            {% else %}
                                <input type="date" name="{{ form.date.name }}" value="{{ form.instance.date|date:'Y-m-d' }}" class="form-control" readonly>
                            {% endif %}
                            {{ form.date.errors }}
                        </td>

                        {# 3. CLIENTE #}
                        <td>
                            {% if is_admin %}
                                {{ form.client_search }}
                                {{ form.cliente_id }}
                            {% else %}
                                <input type="text" class="form-control" value="{{ form.instance.cliente }}" readonly>
                                <input type="hidden" name="{{ form.client_search.name }}" value="{{ form.instance.cliente }}">
                                <input type="hidden" name="{{ form.cliente_id.name }}" value="{{ form.instance.cliente.id }}">
                            {% endif %}
                            
                            <div id="client-balance-container" class="mt-2" style="display: none;">
                                <span id="client-balance-display" class="badge bg-success text-white p-2"></span>
                            </div>
                            {{ form.client_search.errors }}
                        </td>

                        {# 4. VENDEDOR #}
                        <td>
                            {% if is_admin %}
                                {{ form.seller_search }}
                                {{ form.vendedor_id }}
                            {% else %}
                                <input type="text" class="form-control" value="{{ form.instance.vendedor }}" readonly>
                                <input type="hidden" name="{{ form.seller_search.name }}" value="{{ form.instance.vendedor }}">
                                <input type="hidden" name="{{ form.vendedor_id.name }}" value="{{ form.instance.vendedor.id }}">
                            {% endif %}
                            {{ form.seller_search.errors }}
                        </td>

                        {# 5. VALOR VENTA #}
                        <td>
                            {% if is_admin %}
                                <input type="text" id="id_expected_amount" class="form-control text-end" name="expected_amount" value="{{ form.expected_amount.value|stringformat:'.2f' }}">
                            {% else %}
                                <input type="text" id="id_expected_amount" class="form-control text-end" name="expected_amount" value="{{ form.expected_amount.value|stringformat:'.2f' }}" readonly>
                            {% endif %}
                            {{ form.expected_amount.errors }}
                        </td>

                        {# 6. OBSERVACION #}
                        <td>
                            {% if is_admin %}
                                {{ form.description }}
                            {% else %}
                                <textarea class="form-control" rows="2" readonly>{{ form.instance.description }}</textarea>
                                <input type="hidden" name="{{ form.description.name }}" value="{{ form.instance.description }}">
                            {% endif %}
                            {{ form.description.errors }}
                        </td>
                        
                        {# 7. FACTURADOR #}
                        <td>
                            {# Facturador se asigna automaticamente o por admin #}
                            {% if is_admin %}
                                {{ form.facturador }}
                            {% else %}
                                <input type="text" value="{{ form.instance.facturador|default:'' }}" readonly class="form-control">
                            {% endif %}
                            {{ form.facturador.errors }}
                        </td>

                        {# 8. NUMERO FACTURA #}
                        <td>
                            {% if is_admin or is_facturador %}
                                {{ form.numero_factura }}
                            {% else %}
                                <input type="text" class="form-control" value="{{ form.instance.numero_factura|default:'' }}" readonly>
                            {% endif %}
                            {{ form.numero_factura.errors }}
                        </td>

                        {# 9. ESTADO TRANSACCION #}
                        <td class="
                            {% if form.instance.status == 'Facturado' %}bg-verde
                            {% elif form.instance.status == 'Anulado' %}bg-rojo
                            {% elif form.instance.status == 'Pendiente' %}bg-amarillo
                            {% endif %}
                        ">
                            {% if is_admin or is_facturador %}
                                {{ form.status }}
                            {% else %}
                                {{ form.instance.status }}
                                <input type="hidden" name="{{ form.status.name }}" value="{{ form.instance.status }}">
                            {% endif %}
                            {{ form.status.errors }}
                        </td>

                    </tr>
                </tbody>
            </table>
        </fieldset>

        {% if available_credits %}
        <fieldset class="mt-4">
            <legend>Abonos Disponibles para Aplicar</legend>
            <p>Este cliente tiene un saldo a favor. Selecciona los abonos que deseas aplicar a esta transacción.</p>
            
            <div class="available-credits-list p-3 border rounded bg-light">
                <!-- En records/transaction_form.html, dentro de la sección de "Abonos Disponibles" -->

                {% for credit in available_credits %}
                <div class="form-check">
                    <input class="form-check-input apply-credit-checkbox" 
                        type="checkbox" 
                        name="apply_credit" 
                        value="{{ credit.pk }}"
                        data-value="{{ credit.valor|stringformat:'f' }}"
                        id="apply_credit_{{ credit.pk }}">
                        
                    <label class="form-check-label" for="apply_credit_{{ credit.pk }}">
                        Aplicar Abono: {{ credit.fecha }} - {{ credit.comprobante }} - Valor: ${{ credit.valor|floatformat:2 }}
                    </label>
                </div>
                {% endfor %}

                {% comment %} {% for credit in available_credits %}
                <div class="form-check">
                    {# Todos pueden ver abonos, pero solo Admin y Digitador deberian poder aplicarlos activamente #}
                    {# Aunque la logica original permitia a todos, vamos a restringirlo si es necesario. #}
                    {# Por ahora, Admin y Digitador pueden aplicar. #}
                    {% if request.user.is_superuser or 'Digitador' in user_groups %}
                        <input class="form-check-input" type="checkbox" name="apply_credit" value="{{ credit.pk }}" id="credit_{{ credit.pk }}">
                    {% else %}
                        <input class="form-check-input" type="checkbox" disabled>
                    {% endif %}
                    <label class="form-check-label" for="credit_{{ credit.pk }}">
                        id: {{ credit.pk }} | Fecha: {{ credit.fecha }}  | Comprobante: {{ credit.comprobante }} | Banco: {{ credit.banco_llegada }} | Valor: ${{ credit.valor|floatformat:2|intcomma }}
                    </label>
                </div>
                {% endfor %} {% endcomment %}
            </div>
        </fieldset>
        {% endif %}

        {# Financial Records Formset #}
        <fieldset>
            <legend>Recibos Asociados</legend>
            {{ formset.management_form }}
            <div id="formset-container">
                {% for form in formset %}
                    <div class="receipt-form-instance {% if form.errors %}has-errors{% endif %}" id="receipt-form-{{ forloop.counter0 }}">
                        {% if form.instance.pk %}
                            <h5>Recibo existente #{{ forloop.counter }}</h5>
                        {% else %}
                            <h5>Nuevo Recibo</h5>
                        {% endif %}

                        {% if form.non_field_errors %}
                            <div class="non-field-errors">
                                {% for error in form.non_field_errors %}
                                    <p class="errorlist">{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="receipt-form-fields">
                            
                            {# --- LOGICA DE PERMISOS PARA RECIBOS --- #}
                            
                            {# ORIGEN TRANSACCION #}
                            <div class="receipt-field">
                                {{ form.origen_transaccion.label_tag }}
                                {% if is_admin %}
                                    {{ form.origen_transaccion }}
                                {% elif is_digitador and not form.instance.pk %}
                                    {# Digitador: Editable solo si es nuevo #}
                                    {{ form.origen_transaccion }}
                                {% else %}
                                    {# Readonly para los demas casos #}
                                    <input type="text" class="form-control" value="{{ form.instance.origen_transaccion }}" readonly>
                                    {# Si es formset, necesitamos los hidden inputs para que Django no se queje de missing management form data o validation errors si el campo es required #}
                                    {% if form.instance.pk %}
                                        <input type="hidden" name="{{ form.origen_transaccion.html_name }}" value="{{ form.instance.origen_transaccion.id }}">
                                    {% endif %}
                                {% endif %}
                                {{ form.origen_transaccion.errors }}
                                
                                {% if form.instance.pk and form.instance.effective_date_message %}
                                    <small style="color: #007bff; display: block;">{{ form.instance.effective_date_message }}</small>
                                {% endif %}
                                <span id="effective-date-message-{{ form.prefix }}" style="color: #007bff; font-size: 0.9em; display: block;"></span>
                            </div>

                            {# FECHA #}
                            <div class="receipt-field">
                                {{ form.fecha.label_tag }}
                                {% if is_admin and not form.instance.pk or is_digitador and not form.instance.pk %}
                                    {# Admin y Digitador pueden editar la fecha SOLO en un recibo NUEVO #}
                                    {{ form.fecha }}
                                {% else %}
                                    {# Para recibos existentes, TODOS (incluido el Admin) ven un campo de solo lectura #}
                                    <input type="date" class="form-control" value="{{ form.instance.fecha|date:'Y-m-d' }}" readonly>
                                    {% if form.instance.pk %}
                                        <input type="hidden" name="{{ form.fecha.html_name }}" value="{{ form.instance.fecha|date:'Y-m-d' }}">
                                    {% endif %}
                                {% endif %}
                                {{ form.fecha.errors }}
                            </div>

                            {# HORA #}
                            <div class="receipt-field">
                                {{ form.hora.label_tag }}
                                {% if is_admin %}
                                    {{ form.hora }}
                                {% elif is_digitador and not form.instance.pk %}
                                    {{ form.hora }}
                                {% else %}
                                    <input type="time" class="form-control" value="{{ form.instance.hora|time:'H:i' }}" readonly>
                                    {% if form.instance.pk %}
                                        <input type="hidden" name="{{ form.hora.html_name }}" value="{{ form.instance.hora|time:'H:i' }}">
                                    {% endif %}
                                {% endif %}
                                {{ form.hora.errors }}
                            </div>

                            {# COMPROBANTE #}
                            <div class="receipt-field">
                                {{ form.comprobante.label_tag }}
                                {% if is_admin %}
                                    {{ form.comprobante }}
                                {% elif is_digitador and not form.instance.pk %}
                                    {{ form.comprobante }}
                                {% else %}
                                    <input type="text" class="form-control" value="{{ form.instance.comprobante }}" readonly>
                                    {% if form.instance.pk %}
                                        <input type="hidden" name="{{ form.comprobante.html_name }}" value="{{ form.instance.comprobante }}">
                                    {% endif %}
                                {% endif %}
                                {{ form.comprobante.errors }}
                            </div>

                            {# BANCO LLEGADA #}
                            <div class="receipt-field">
                                {{ form.banco_llegada.label_tag }}
                                {% if is_admin %}
                                    {{ form.banco_llegada }}
                                {% elif is_digitador and not form.instance.pk %}
                                    {{ form.banco_llegada }}
                                {% else %}
                                    <input type="text" class="form-control" value="{{ form.instance.banco_llegada }}" readonly>
                                    {% if form.instance.pk %}
                                        <input type="hidden" name="{{ form.banco_llegada.html_name }}" value="{{ form.instance.banco_llegada.id }}">
                                    {% endif %}
                                {% endif %}
                                {{ form.banco_llegada.errors }}
                            </div>

                                    {# VALOR #}
                                    <div class="receipt-field">
                                        {{ form.valor.label_tag }}
                                        {% if is_admin %}
                                            {{ form.valor }}
                                        {% elif is_digitador and not form.instance.pk %}
                                            {{ form.valor }}
                                        {% else %}
                                            <input type="text" class="form-control" value="{{ form.instance.valor|stringformat:'.2f' }}" readonly>
                                            {% if form.instance.pk %}
                                                <input type="hidden" name="{{ form.valor.html_name }}" value="{{ form.instance.valor|stringformat:'.2f' }}">
                                            {% endif %}
                                        {% endif %}
                                        {{ form.valor.errors }}
                                    </div>

                            {# ESTADO PAGO #}
                            <div class="receipt-field 
                                {% if form.instance.payment_status == 'Aprobado' %}bg-aprobado
                                {% elif form.instance.payment_status == 'Rechazado' %}bg-rechazado
                                {% elif form.instance.payment_status == 'Pendiente' %}bg-pendiente
                                {% endif %}">
                                {{ form.payment_status.label_tag }}
                                {% if is_admin or is_validador %}
                                    {# Validador puede editar status #}
                                    {{ form.payment_status }}
                                {% else %}
                                    <input type="text" class="form-control" value="{{ form.instance.payment_status }}" readonly>
                                    <input type="hidden" name="{{ form.payment_status.html_name }}" value="{{ form.instance.payment_status }}">
                                {% endif %}
                                {{ form.payment_status.errors }}
                            </div>

                            {# DELETE BUTTON #}
                            {# DELETE / UNLINK BUTTONS #}
                            <div class="receipt-delete-wrapper">
                                {% comment %} {% if formset.can_delete %}
                                    {% if is_admin %}
                                        {# Admin can delete anything #}
                                        <div class="delete-checkbox" style="display: none;">{{ form.DELETE }}</div>
                                        <button type="button" class="btn btn-danger btn-delete-receipt">Eliminar</button>
                                        <button type="button" class="btn btn-secondary btn-undo-delete" style="display: none;">Deshacer</button>
                                    {% elif is_digitador and not form.instance.pk %}
                                        {# Digitador can delete NEW receipts #}
                                        <div class="delete-checkbox" style="display: none;">{{ form.DELETE }}</div>
                                        <button type="button" class="btn btn-danger btn-delete-receipt">Eliminar</button>
                                    {% endif %}
                                {% endif %} {% endcomment %}

                                {# Unlink Logic for Existing Records #}
                                {% if form.instance.pk %}
                                    {% if is_admin  %}
                                        <div class="unlink-checkbox-wrapper" style="display: none;">
                                            <input type="checkbox" name="unlink_credit" value="{{ form.instance.pk }}">
                                        </div>
                                        <button type="button" class="btn btn-warning btn-unlink-receipt" style="margin-left: 5px;">Desvincular</button>
                                        <button type="button" class="btn btn-secondary btn-undo-unlink" style="display: none; margin-left: 5px;">Re-vincular</button>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {{ form.id }}
                    </div>
                {% endfor %}
            </div>
           
            {% if request.user.is_superuser or 'Digitador' in user_groups %}
                <button type="button" id="add-receipt-btn">Añadir Recibo</button>
            {% endif %} 
        </fieldset>


        <div class="d-flex justify-content-start gap-2 mt-4">
            <button type="submit" class="btn btn-primary d-flex align-items-center">
                <img src="{% static 'images/floppy-disk-regular-full.svg' %}" alt="Guardar" width="20" height="20" class="me-2">Guardar Cambios
            </button>
            {% comment %} {% if user.is_superuser %}
            <button type="button" id="btn-delete-transaction" class="btn-delete-transaction btn-accion-icono">
                <img src="{% static 'images/trash-solid-full.svg' %}" alt="Eliminar" width="20" height="20" class="me-2">
            </button>
            {% endif %} {% endcomment %}
            <a href="{% url 'record_list' %}" class="btn btn-secondary d-flex align-items-center">Atrás</a>
        </div>
    </form>

    {# Modal de Confirmación para Recibos (ya existente) #}
    <div id="delete-confirm-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h4>Confirmar Eliminación</h4>
            <p>¿Estás seguro de que quieres eliminar este recibo?</p>
            <div class="modal-buttons">
                <button type="button" id="modal-confirm-delete" class="btn btn-danger">Confirmar</button>
                <button type="button" id="modal-cancel-delete" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    {# NUEVO Modal de Confirmación para Transacción #}
    <div id="delete-transaction-confirm-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h4>Confirmar Eliminación</h4>
            <p>¿Estás seguro de que quieres eliminar esta transacción completa y todos sus recibos asociados?</p>
            <div class="modal-buttons">
                <a href="{% url 'transaction_delete' object.pk %}" class="btn btn-danger">Confirmar Eliminación</a>
                <button type="button" class="btn btn-secondary" id="modal-cancel-delete-transaction">Cancelar</button>
            </div>
        </div>
    </div>

    <template id="empty-form-template">
        <div class="receipt-form-instance" id="receipt-form-__prefix__">
            <h5>Nuevo Recibo</h5>
            <div class="receipt-form-fields">
                <div class="receipt-field">
                    {{ formset.empty_form.origen_transaccion.label_tag }}
                    {{ formset.empty_form.origen_transaccion }}
                </div>
                <div class="receipt-field">
                    {{ formset.empty_form.fecha.label_tag }}
                    {{ formset.empty_form.fecha }}
                </div>
                <div class="receipt-field">{{ formset.empty_form.hora.label_tag }}{{ formset.empty_form.hora }}</div>
                <div class="receipt-field">{{ formset.empty_form.comprobante.label_tag }}{{ formset.empty_form.comprobante }}</div>
                <div class="receipt-field">{{ formset.empty_form.banco_llegada.label_tag }}{{ formset.empty_form.banco_llegada }}</div>
                <div class="receipt-field">{{ formset.empty_form.valor.label_tag }}{{ formset.empty_form.valor }}</div>
                <div class="receipt-delete-wrapper">
                    {% if formset.can_delete %}
                        <div class="delete-checkbox" style="display: none;">{{ formset.empty_form.DELETE }}</div>
                        <button type="button" class="btn btn-danger btn-delete-receipt">Eliminar</button>
                        <button type="button" class="btn btn-secondary btn-undo-delete" style="display: none;">Deshacer</button>
                    {% endif %}
                </div>
            </div>
            {{ formset.empty_form.id }}
        </div>
    </template>

    <style>
        .transaction-form-table {
            width: 100%; margin-bottom: 20px; border-collapse: collapse;
        }
        .transaction-form-table th, .transaction-form-table td {
            padding: 12px; vertical-align: top; border-top: 1px solid #dee2e6;
        }
        .transaction-form-table th {
            text-align: left; width: 20%; font-weight: bold;
        }
        .transaction-form-table input, .transaction-form-table select, .transaction-form-table textarea {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .transaction-form-table .errorlist {
            color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px; margin: 5px 0 0 0; list-style-type: none;
        }

        .receipt-form-instance {
            border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #f9f9f9; transition: background-color 0.3s ease;
        }
        .receipt-form-fields {
            display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-start;
        }
        .receipt-field {
            display: flex; flex-direction: column; flex: 1; min-width: 150px;
        }
        .receipt-field label {
            font-weight: bold; margin-bottom: 5px;
        }
        .receipt-field input, .receipt-field select {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .receipt-delete-wrapper {
            flex: 0 0 100px; display: flex; align-items: flex-end; padding-bottom: 8px;
        }

        .receipt-form-instance.marked-for-deletion {
            background-color: #f8d7da;
            opacity: 0.6;
        }
        .receipt-form-instance.marked-for-deletion input, .receipt-form-instance.marked-for-deletion select {
            text-decoration: line-through;
        }
        /* --- NUEVO: Estilo para recibos marcados para desvincular --- */
        .receipt-form-instance.marked-for-unlinking {
            background-color: #fff3cd; /* Color de advertencia claro */
            border-color: #ffeeba;
        }
        .receipt-form-instance.marked-for-unlinking .receipt-form-fields {
            opacity: 0.7;
        }


        .receipt-form-instance.has-errors { border-color: red; background-color: #ffebeb; }
        .non-field-errors { color: red; font-weight: bold; margin-bottom: 10px; }
        .errorlist { color: red; margin: 5px 0 0 0; padding: 0; list-style-type: none; }
        #add-receipt-btn { margin-top: 10px; padding: 8px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #add-receipt-btn:hover { background-color: #218838; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }

        /* Modal Styles */
        .modal { position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; outline: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
        .modal-content { position: relative; background-color: #fefefe; padding: 20px; border: 1px solid #888; width: auto; max-width: 500px; border-radius: 8px; text-align: center; }
        .modal-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>

    {# --- INICIO: NUEVAS CLASES CSS PARA COLORES --- #}
    <style>
        .bg-verde {
            background-color: #28a745 !important; /* Verde éxito */
            color: white;
        }
        .bg-rojo {
            background-color: #dc3545 !important; /* Rojo peligro */
            color: white;
        }
        .bg-amarillo {
            background-color: #ffc107 !important; /* Amarillo advertencia */
            color: black;
        }
    </style>
    {# --- FIN: NUEVAS CLASES CSS PARA COLORES --- #}
<!-- Al final de records/transaction_form.html -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Obtener elementos y valores iniciales del DOM
        const summaryContainer = document.getElementById('transaction-summary');
        if (!summaryContainer) {
            console.error('El contenedor del resumen #transaction-summary no fue encontrado.');
            return;
        }

        const expectedAmount = parseFloat(summaryContainer.dataset.expectedAmount);
        const initialReceiptsTotal = parseFloat(summaryContainer.dataset.initialReceipts);

        const totalReceiptsDisplay = document.getElementById('total-receipts-display');
        const differenceDisplay = document.getElementById('transaction-difference-display');

        // 2. Seleccionar todos los checkboxes relevantes
        const applyCheckboxes = document.querySelectorAll('.apply-credit-checkbox');
        const unlinkCheckboxes = document.querySelectorAll('.unlink-credit-checkbox');

        // 3. Función para recalcular y actualizar la UI
        function updateTotals() {
            let creditsToApplyTotal = 0;
            applyCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    creditsToApplyTotal += parseFloat(checkbox.dataset.value);
                }
            });

            let creditsToUnlinkTotal = 0;
            unlinkCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    creditsToUnlinkTotal += parseFloat(checkbox.dataset.value);
                }
            });

            // El nuevo total de recibos es:
            // (Total inicial) + (Abonos que estoy aplicando) - (Recibos que estoy desvinculando)
            const newTotalReceipts = initialReceiptsTotal + creditsToApplyTotal - creditsToUnlinkTotal;
            
            // La nueva diferencia
            const newDifference = expectedAmount - newTotalReceipts;

            // Actualizar el HTML con los nuevos valores formateados
            totalReceiptsDisplay.textContent = newTotalReceipts.toLocaleString('es-CO', { style: 'currency', currency: 'COP' });
            differenceDisplay.textContent = newDifference.toLocaleString('es-CO', { style: 'currency', currency: 'COP' });

            // Cambiar color de la diferencia si es necesario
            if (newDifference < 0) {
                differenceDisplay.style.color = 'red';
            } else if (newDifference === 0) {
                differenceDisplay.style.color = 'green';
            } else {
                differenceDisplay.style.color = 'orange';
            }
        }

        // 4. Añadir "listeners" a todos los checkboxes
        applyCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateTotals);
        });

        unlinkCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateTotals);
        });

        // 5. (Opcional) Llamar a la función una vez al cargar la página por si hay valores pre-marcados
        updateTotals();
    });
    </script>

    <script>
    // Usamos jQuery para el autocompletado
    document.addEventListener('DOMContentLoaded', function() {
        // --- LÓGICA PARA SALDO DE CLIENTE (NUEVA) ---
        const clientSelect = document.getElementById('id_cliente');
        const balanceContainer = document.getElementById('client-balance-container');
        const balanceDisplay = document.getElementById('client-balance-display');

        function updateBalance(clientId) {
            if (!clientId) {
                if(balanceContainer) balanceContainer.style.display = 'none';
                return;
            }

            fetch(`/ajax/get_client_balance/?client_id=${clientId}`)
                .then(response => response.json())
                .then(data => {
                    if (balanceContainer && balanceDisplay && data.balance !== undefined) {
                        const balanceValue = parseFloat(data.balance.replace(/,/g, ''));
                        if (balanceValue > 0) {
                            balanceDisplay.textContent = `Saldo a favor: $${data.balance}`;
                            balanceContainer.style.display = 'block';
                        } else {
                            balanceContainer.style.display = 'none';
                        }
                    } else {
                       if(balanceContainer) balanceContainer.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching client balance:', error);
                    if(balanceContainer) balanceContainer.style.display = 'none';
                });
        }

        if (clientSelect) {
            // Al cargar la página, verificar si ya hay un cliente seleccionado
            if (clientSelect.value) {
                updateBalance(clientSelect.value);
            }
            // Al cambiar la selección del cliente
            clientSelect.addEventListener('change', function() {
                updateBalance(this.value);
            });
        }
        // --- FIN LÓGICA SALDO CLIENTE ---

        const formsetContainer = document.getElementById('formset-container');
        const addReceiptBtn = document.getElementById('add-receipt-btn');
        const totalForms = document.querySelector('#id_receipts-TOTAL_FORMS');
        const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
        
        // Modal elements
        const modal = document.getElementById('delete-confirm-modal');
        const closeModal = modal.querySelector('.close-button');
        const confirmDeleteBtn = document.getElementById('modal-confirm-delete');
        const cancelDeleteBtn = document.getElementById('modal-cancel-delete');
        let formToMarkForDeletion = null;

        function showModal(formInstance) {
            formToMarkForDeletion = formInstance;
            modal.style.display = 'flex';
        }

        function hideModal() {
            formToMarkForDeletion = null;
            modal.style.display = 'none';
        }

        function markForDeletion(formInstance) {
            const deleteCheckbox = formInstance.querySelector('[id$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                formInstance.classList.add('marked-for-deletion');
                formInstance.querySelector('.btn-delete-receipt').style.display = 'none';
                formInstance.querySelector('.btn-undo-delete').style.display = 'inline-block';
            }
        }

        function undoMarkForDeletion(formInstance) {
            const deleteCheckbox = formInstance.querySelector('[id$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = false;
                formInstance.classList.remove('marked-for-deletion');
                formInstance.querySelector('.btn-delete-receipt').style.display = 'inline-block';
                formInstance.querySelector('.btn-undo-delete').style.display = 'none';
            }
        }

        function markForUnlinking(formInstance) {
            const unlinkCheckbox = formInstance.querySelector('input[name="unlink_credit"]');
            if (unlinkCheckbox) {
                unlinkCheckbox.checked = true;
                formInstance.classList.add('marked-for-unlinking');
                formInstance.querySelector('.btn-unlink-receipt').style.display = 'none';
                formInstance.querySelector('.btn-undo-unlink').style.display = 'inline-block';
            }
        }

        function undoMarkForUnlinking(formInstance) {
            const unlinkCheckbox = formInstance.querySelector('input[name="unlink_credit"]');
            if (unlinkCheckbox) {
                unlinkCheckbox.checked = false;
                formInstance.classList.remove('marked-for-unlinking');
                formInstance.querySelector('.btn-unlink-receipt').style.display = 'inline-block';
                formInstance.querySelector('.btn-undo-unlink').style.display = 'none';
            }
        }
        // Event listeners for modal buttons
        confirmDeleteBtn.addEventListener('click', function() {
            if (formToMarkForDeletion) {
                markForDeletion(formToMarkForDeletion);
            }
            hideModal();
        });

        cancelDeleteBtn.addEventListener('click', hideModal);
        closeModal.addEventListener('click', hideModal);
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                hideModal();
            }
        });

        // Event delegation for delete and undo buttons
        formsetContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('btn-delete-receipt')) {
                const formInstance = event.target.closest('.receipt-form-instance');
                showModal(formInstance);
            }
            if (event.target.classList.contains('btn-undo-delete')) {
                const formInstance = event.target.closest('.receipt-form-instance');
                undoMarkForDeletion(formInstance);
            }
            // --- NUEVO: Eventos para desvincular/re-vincular ---
            if (event.target.classList.contains('btn-unlink-receipt')) {
                const formInstance = event.target.closest('.receipt-form-instance');
                markForUnlinking(formInstance);
            }
            if (event.target.classList.contains('btn-undo-unlink')) {
                const formInstance = event.target.closest('.receipt-form-instance');
                undoMarkForUnlinking(formInstance);
            }
        });

        // Add new form
        if(addReceiptBtn) {
            addReceiptBtn.addEventListener('click', function() {
                const formIndex = totalForms.value;
                const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formIndex);
                formsetContainer.insertAdjacentHTML('beforeend', newFormHtml);
                totalForms.value = parseInt(formIndex) + 1;
            });
        }

        // --- CÓDIGO PARA CALCULAR FECHA EFECTIVA ---
        const receiptFormsetContainer = document.getElementById('formset-container');
        if (receiptFormsetContainer) {
            receiptFormsetContainer.addEventListener('change', (e) => {
                if (e.target.matches('select[name$="-origen_transaccion"]') || e.target.matches('input[name$="-fecha"]')) {
                    const formPrefix = e.target.name.match(/(receipts-\d+)-/)?.[1] || e.target.name.match(/(form-\d+)-/)?.[1];
                    if (!formPrefix) return;

                    const formNum = formPrefix.split('-')[1];

                    const origenSelect = document.querySelector(`#id_${formPrefix}-origen_transaccion`);
                    const fechaInput = document.querySelector(`#id_${formPrefix}-fecha`);
                    const messageSpan = document.querySelector(`#effective-date-message-${formPrefix}`);

                    if (!origenSelect || !fechaInput || !messageSpan) return;

                    const origenId = origenSelect.value;
                    const fecha = fechaInput.value;

                    if (origenId && fecha) {
                        const url = `{% url 'get_effective_date' %}?origen_id=${origenId}&start_date=${fecha}`;
                        fetch(url)
                            .then(response => response.json())
                            .then(data => {
                                messageSpan.textContent = data.message || '';
                            })
                            .catch(error => console.error('Error:', error));
                    } else {
                        messageSpan.textContent = '';
                    }
                }
            });
        }



        // --- NUEVO: Lógica para el modal de eliminación de transacción ---
        const deleteTransactionModal = document.getElementById('delete-transaction-confirm-modal');
        const openDeleteTransactionModalBtn = document.getElementById('btn-delete-transaction');
        const closeDeleteTransactionModalBtn = deleteTransactionModal.querySelector('.close-button');
        const cancelDeleteTransactionModalBtn = document.getElementById('modal-cancel-delete-transaction');

        if(openDeleteTransactionModalBtn) {
            openDeleteTransactionModalBtn.addEventListener('click', function() {
                deleteTransactionModal.style.display = 'flex';
            });
        }

        const closeTxModal = () => deleteTransactionModal.style.display = 'none';

        if(closeDeleteTransactionModalBtn) {
            closeDeleteTransactionModalBtn.addEventListener('click', closeTxModal);
        }
        if(cancelDeleteTransactionModalBtn) {
            cancelDeleteTransactionModalBtn.addEventListener('click', closeTxModal);
        }

        window.addEventListener('click', function(event) {
            if (event.target == deleteTransactionModal) {
                closeTxModal();
            }
        });

        // --- LÓGICA DE CÁLCULO DE TOTALES ---
        const expectedAmountInput = document.getElementById('id_expected_amount');
        const totalReceiptsAmountOutput = document.getElementById('id_total_receipts_amount');
        const differenceOutput = document.getElementById('id_difference');

        function updateTotals() {
            const parseCustomFloat = (str) => {
                if (!str) return 0;
                const cleaned = str.toString().replace(/,/g, '');
                return parseFloat(cleaned) || 0;
            };

            let totalReceipts = 0;
            const valorInputs = formsetContainer.querySelectorAll('input[name$="-valor"]');

            valorInputs.forEach(input => {
                const formInstance = input.closest('.receipt-form-instance');
                if (!formInstance) return;

                const isDeleted = formInstance.querySelector('input[type="checkbox"][name$="-DELETE"]')?.checked;
                const isHidden = formInstance.style.display === 'none';

                if (!isDeleted && !isHidden) {
                    const value = parseCustomFloat(input.value);
                    totalReceipts += value;
                }
            });

            const expected = parseCustomFloat(expectedAmountInput.value);
            const difference = expected - totalReceipts;

            const numberFormatOptions = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
            totalReceiptsAmountOutput.value = totalReceipts.toLocaleString('en-US', numberFormatOptions);
            differenceOutput.value = difference.toLocaleString('en-US', numberFormatOptions);

            differenceOutput.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-white', 'text-dark');

            if (difference < -0.001) {
                differenceOutput.classList.add('bg-warning', 'text-dark');
            } else if (difference > 0.001) {
                differenceOutput.classList.add('bg-danger', 'text-white');
            } else {
                differenceOutput.classList.add('bg-success', 'text-white');
            }
        }

        function formatNumberInput(input) {
            if (!input || !input.value) {
                updateTotals();0
                return;
            }
            let value = input.value.trim();
            const numericValue = parseFloat(value.replace(/,/g, ''));
            if (isNaN(numericValue)) {
                updateTotals();
                return;
            }
            const numberFormatOptions = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
            input.value = numericValue.toLocaleString('en-US', numberFormatOptions);
            updateTotals();
        }

    function handleTotalsUpdate(e) {
        const target = e.target;
        if (target && (target.matches('input[name$="-valor"]') || target.id === 'id_expected_amount')) {
            let currentValue = target.value;

            // Permitir signo negativo solo al inicio y dígitos, puntos o comas
            const sanitizedValue = currentValue
                .replace(/(?!^)-/g, '')  // elimina guiones que no estén al inicio
                .replace(/[^0-9.,-]/g, ''); // permite números, punto, coma y el guion inicial

            if (currentValue !== sanitizedValue) {
                target.value = sanitizedValue;
            }

            updateTotals();
        }
    }

        function handleFormatting(e) {
            const target = e.target;
            if (target && (target.matches('input[name$="-valor"]') || target.id === 'id_expected_amount')) {
                formatNumberInput(target);
            }
        }

        if (expectedAmountInput) {
            expectedAmountInput.addEventListener('input', handleTotalsUpdate);
            expectedAmountInput.addEventListener('blur', handleFormatting);
        }

        formsetContainer.addEventListener('input', handleTotalsUpdate);
        formsetContainer.addEventListener('blur', handleFormatting, true);

        const mainForm = document.getElementById('transaction-form');
        if (mainForm) {
            mainForm.addEventListener('submit', function() {
                if (expectedAmountInput && expectedAmountInput.value) {
                    expectedAmountInput.value = expectedAmountInput.value.replace(/,/g, '');
                }
                const valorInputs = formsetContainer.querySelectorAll('input[name$="-valor"]');
                valorInputs.forEach(function(input) {
                    if (input.value) {
                        input.value = input.value.replace(/,/g, '');
                    }
                });
            });
        }

        updateTotals();
    });
    </script>

    <script>
    // Usamos $(document).ready() que es el equivalente de jQuery a DOMContentLoaded
    $(document).ready(function() {
        // --- LÓGICA DE AUTOCOMPLETADO PARA CLIENTE ---
        const clientSearchInput = $("#id_client_search");
        const clientIdHiddenInput = $("#id_cliente_id");

        clientSearchInput.autocomplete({
            source: "{% url 'client_search_ajax' %}",
            minLength: 2,
            select: function(event, ui) {
                clientIdHiddenInput.val(ui.item.id).trigger('change'); // Asignar ID y disparar 'change'
                clientSearchInput.val(ui.item.label);
                updateBalance(ui.item.id); // Actualizar saldo al seleccionar
                return false;
            },
            focus: function(event, ui) {
                clientSearchInput.val(ui.item.label);
                return false;
            }
        });

        clientSearchInput.on('keyup input', function() {
            if ($(this).val().trim() === '') {
                clientIdHiddenInput.val('').trigger('change'); // Limpiar ID y disparar 'change'
            }
        });

        // --- LÓGICA DE AUTOCOMPLETADO PARA VENDEDOR ---
        const sellerSearchInput = $("#id_seller_search");
        const sellerIdHiddenInput = $("#id_vendedor_id");

        sellerSearchInput.autocomplete({
            source: "{% url 'seller_search_ajax' %}",
            minLength: 2,
            select: function(event, ui) {
                sellerIdHiddenInput.val(ui.item.id);
                sellerSearchInput.val(ui.item.label);
                return false;
            },
            focus: function(event, ui) {
                sellerSearchInput.val(ui.item.label);
                return false;
            }
        });

        sellerSearchInput.on('keyup input', function() {
            if ($(this).val().trim() === '') {
                sellerIdHiddenInput.val('');
            }
        });
    });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Itera sobre cada formulario del formset
        {% for form in formset %}
            // Obtiene el campo de fecha por su ID único
            const dateInput = document.getElementById('{{ form.fecha.id_for_label }}');
            
            // Verifica si el campo existe y si tiene un valor inicial desde la base de datos
            {% if form.instance.fecha %}
                if (dateInput) {
                    // Crea un objeto Date a partir de la fecha de la instancia
                    const dateObj = new Date('{{ form.instance.fecha|date:"Y-m-d" }}T00:00:00');
                    // Formatea la fecha a YYYY-MM-DD y la asigna al valor del input
                    dateInput.value = dateObj.toISOString().split('T')[0];
                }
            {% endif %}
        {% endfor %}
    });
    </script>
{% endblock %}
