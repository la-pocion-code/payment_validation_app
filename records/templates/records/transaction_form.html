{% extends 'records/base.html' %}
{% load humanize %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
    <h2>{{ title }}</h2>
    <div class="d-flex align-items-end gap-2 mb-3">
        <label for="id_total_receipts_amount" class="form-label">Valor Recibos</label>
        <input type="text" id="id_total_receipts_amount" class="form-control text-end"
            value="{{ total_receipts_amount|default:0|floatformat:2|intcomma }}" readonly style="width:140px;">
        
        <label for="id_difference" class="form-label">Diferencia</label>
        <input type="text" id="id_difference" class="form-control text-end 
            {% if difference == 0 %}bg-verde
            {% elif difference > 0 %}bg-rojo
            {% elif difference < 0 %}bg-amarillo
            {% endif %}
        " value="{{ difference|default:0|floatformat:2|intcomma }}" readonly style="width:140px;">
    </div>

    <form method="post" id="transaction-form">
        {% csrf_token %}
        {# Transaction Form #}
        <fieldset>
            <legend>Detalles de la Transacción # {{ transaction.unique_transaction_id }}</legend>
            <table class="transaction-details-horizontal">
               
                <tbody>
                    <tr>
                        <th>Tipo Transacción</th>
                        <th>Fecha Transaccón</th>
                        <th>Cliente</th>
                        <th>Vendedor</th>
                        <th>Valor Venta</th>
                        <th>Descripción</th>
                        <th>Facturador</th>
                        <th># de Factura</th>
                        <th>Estado Transacción</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                    {# --- INICIO DE LA CORRECCIÓN --- #}
                    {# Unificamos la lógica. Siempre mostramos los campos del formulario. #}
                    {# La lógica de 'readonly' ya está manejada en el TransactionForm. #}
                        <td>{{ form.transaction_type }} {{ form.transaction_type.errors }}</td>
                        <td>
                            <input type="date" name="{{ form.date.name }}" value="{{ form.instance.date|date:'Y-m-d' }}"
                                   class="form-control" id="{{ form.date.id_for_label }}" {% if form.date.field.widget.attrs.readonly %}readonly{% endif %}>
                            {{ form.date.errors }}</td>
                        <td>
                            {{ form.client_search }}
                            {{ form.cliente_id }} {# CAMPO OCULTO #}
                            <div id="client-balance-container" class="mt-2" style="display: none;">
                                <span id="client-balance-display" class="badge bg-success text-white p-2"></span>
                            </div>
                            {{ form.client_search.errors }}
                        </td>
                        <td>{{ form.seller_search }} {{ form.seller_search.errors }}</td>
                        <td>
                            {{ form.seller_search }}
                            {{ form.vendedor_id }} {# CAMPO OCULTO #}
                            {{ form.seller_search.errors }}
                        </td>
                        <!-- Campo Valor Venta con validación -->
                        <td>
                                <input type="text"
                                    id="id_expected_amount"
                                    class="form-control text-end"
                                    name="expected_amount"
                                    value="{{ form.expected_amount.value|floatformat:2|intcomma }}">
                            {{ form.expected_amount.errors }}
                        </td>

                        <td>{{ form.description }} {{ form.description.errors }}</td>
                    {# --- FIN DE LA CORRECCIÓN --- #}

                        <!-- Facturador -->
                        <td>
                            {% if request.user.is_superuser or 'Digitador' not in user_groups %}
                                {{ form.facturador }}
                            {% else %}
                                <input type="text" value="{{ request.user.username }}" readonly class="form-control">
                                <input type="hidden" name="facturador" value="{{ request.user.username }}">
                            {% endif %}
                            {{ form.facturador.errors }}
                        </td>

                        <td>{{ form.numero_factura }} {{ form.numero_factura.errors }}</td>

                        <!-- Celda Estado Transacción con color condicional -->
                        <td class="
                            {% if form.instance.status == 'Facturado' %}bg-verde
                            {% elif form.instance.status == 'Anulado' %}bg-rojo
                            {% elif form.instance.status == 'Pendiente' %}bg-amarillo
                            {% endif %}
                        ">{{ form.status }} {{ form.status.errors }}</td>

                    </tr>
                </tbody>
            </table>
        </fieldset>

        {% if available_credits %}
        <fieldset class="mt-4">
            <legend>Abonos Disponibles para Aplicar</legend>
            <p>Este cliente tiene un saldo a favor. Selecciona los abonos que deseas aplicar a esta transacción.</p>
            
            <div class="available-credits-list p-3 border rounded bg-light">
                {% for credit in available_credits %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="apply_credit" value="{{ credit.pk }}" id="credit_{{ credit.pk }}">
                    <label class="form-check-label" for="credit_{{ credit.pk }}">
                        Fecha: {{ credit.fecha }} | Valor: ${{ credit.valor|floatformat:2|intcomma }} | Comprobante: {{ credit.comprobante }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </fieldset>
        {% endif %}

        {# Financial Records Formset #}
        <fieldset>
            <legend>Recibos Asociados</legend>
            {{ formset.management_form }}
            <div id="formset-container">
                {% for form in formset %}
                    <div class="receipt-form-instance {% if form.errors %}has-errors{% endif %}" id="receipt-form-{{ forloop.counter0 }}">
                        {% if form.instance.pk %}
                            <h5>Recibo existente #{{ forloop.counter }}</h5>
                        {% else %}
                            <h5>Nuevo Recibo</h5>
                        {% endif %}

                        {% if form.non_field_errors %}
                            <div class="non-field-errors">
                                {% for error in form.non_field_errors %}
                                    <p class="errorlist">{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="receipt-form-fields">
                            {% if request.user.is_superuser or 'Digitador' in user_groups %}
                                <div class="receipt-field">
                                    {{ form.origen_transaccion.label_tag }}
                                    {{ form.origen_transaccion }}

                                    <!-- 1. Mensaje para recibos ya guardados (desde el modelo) -->
                                    {% if form.instance.pk and form.instance.effective_date_message %}
                                        <small style="color: #007bff; display: block;">{{ form.instance.effective_date_message }}</small>
                                    {% endif %}

                                    <!-- 2. Placeholder para el mensaje dinámico de JavaScript -->
                                    <span id="effective-date-message-{{ form.prefix }}" style="color: #007bff; font-size: 0.9em; display: block;"></span>

                                    {{ form.origen_transaccion.errors }}
                                </div>
                                <div class="receipt-field">
                                    {{ form.fecha.label_tag }}
                                    {{ form.fecha}}
                                    {{ form.fecha.errors }}
                                </div>
                                <div class="receipt-field">
                                    {{ form.hora.label_tag }}
                                    {{ form.hora }} {# Dejamos que Django renderice el campo principal #}
                                    {% if form.hora.field.widget.attrs.readonly %}
                                        <input type="hidden" name="{{ form.hora.name }}" value="{{ form.instance.hora|time:'H:i:s' }}">
                                    {% endif %}
                                    {{ form.hora.errors }}
                                </div>
                                <div class="receipt-field">{{ form.comprobante.label_tag }}{{ form.comprobante }}{{ form.comprobante.errors }}</div>
                                <div class="receipt-field">{{ form.banco_llegada.label_tag }}{{ form.banco_llegada }}{{ form.banco_llegada.errors }}</div>
                                <div class="receipt-field">{{ form.valor.label_tag }}{{ form.valor }}{{ form.valor.errors }}</div>
                                <div class="receipt-field 
                                    {% if form.instance.payment_status == 'Aprobado' %}bg-aprobado
                                    {% elif form.instance.payment_status == 'Rechazado' %}bg-rechazado
                                    {% elif form.instance.payment_status == 'Pendiente' %}bg-pendiente
                                    {% endif %}">
                                    {{ form.payment_status.label_tag }}{{ form.payment_status }}{{ form.payment_status.errors }}
                                </div>
                                {% comment %} <div class="receipt-delete-wrapper">    
                                    {% if formset.can_delete %}
                                        <div class="delete-checkbox" style="display: none;">{{ form.DELETE }}</div>
                                        <button type="button" class="btn btn-danger btn-delete-receipt">Eliminar</button>
                                        <button type="button" class="btn btn-secondary btn-undo-delete" style="display: none;">Deshacer</button>
                                    {% endif %}
                                </div> {% endcomment %}
                            {% else %}
                                <div class="receipt-field">
                                    {{ form.origen_transaccion.label_tag }}
                                    {{ form.origen_transaccion }}

                                    <!-- 1. Mensaje para recibos ya guardados (desde el modelo) -->
                                    {% if form.instance.pk and form.instance.effective_date_message %}
                                        <small style="color: #007bff; display: block;">{{ form.instance.effective_date_message }}</small>
                                    {% endif %}

                                    <!-- 2. Placeholder para el mensaje dinámico de JavaScript -->
                                    <span id="effective-date-message-{{ form.prefix }}" style="color: #007bff; font-size: 0.9em; display: block;"></span>

                                    {{ form.origen_transaccion.errors }}
                                </div>
                                <div class="receipt-field">
                                    {{ form.fecha.label_tag }}
                                    <input type="date" name="{{ form.fecha.name }}" value="{{ form.instance.fecha|date:'Y-m-d' }}"
                                </div>
                                <div class="receipt-field">
                                    {{ form.hora.label_tag }}
                                    {{ form.hora }}
                                    {% if form.hora.field.widget.attrs.readonly %}
                                        <input type="hidden" name="{{ form.hora.name }}" value="{{ form.instance.hora|time:'H:i:s' }}">
                                    {% endif %}
                                    {{ form.hora.errors }}
                                </div>
                                <div class="receipt-field">{{ form.comprobante.label_tag }}{{ form.comprobante }}{{ form.comprobante.errors }}</div>
                                <div class="receipt-field">{{ form.banco_llegada.label_tag }}{{ form.banco_llegada }}{{ form.banco_llegada.errors }}</div>
                                <div class="receipt-field">{{ form.valor.label_tag }}{{ form.valor }}{{ form.valor.errors }}</div>
                                <div class="receipt-field 
                                    {% if form.instance.payment_status == 'Aprobado' %}bg-aprobado
                                    {% elif form.instance.payment_status == 'Rechazado' %}bg-rechazado
                                    {% elif form.instance.payment_status == 'Pendiente' %}bg-pendiente
                                    {% endif %}">
                                    {{ form.payment_status.label_tag }}{{ form.payment_status }}{{ form.payment_status.errors }}
                                </div>
                            {% endif %}
                        </div>
                        {{ form.id }}
                    </div>
                {% endfor %}
            </div>
           
            {% if request.user.is_superuser or 'Digitador' in user_groups %}
                <button type="button" id="add-receipt-btn">Añadir Recibo</button>
            {% endif %} 
        </fieldset>


        <div class="d-flex justify-content-start gap-2 mt-4">
            <button type="submit" class="btn btn-primary d-flex align-items-center">
                <img src="{% static 'images/floppy-disk-regular-full.svg' %}" alt="Guardar" width="20" height="20" class="me-2">Guardar Cambios
            </button>
            {% comment %} {% if user.is_superuser %}
            <button type="button" id="btn-delete-transaction" class="btn-delete-transaction btn-accion-icono">
                <img src="{% static 'images/trash-solid-full.svg' %}" alt="Eliminar" width="20" height="20" class="me-2">
            </button>
            {% endif %} {% endcomment %}
            <a href="{% url 'record_list' %}" class="btn btn-secondary d-flex align-items-center">Atrás</a>
        </div>
    </form>

    {# Modal de Confirmación para Recibos (ya existente) #}
    <div id="delete-confirm-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h4>Confirmar Eliminación</h4>
            <p>¿Estás seguro de que quieres eliminar este recibo?</p>
            <div class="modal-buttons">
                <button type="button" id="modal-confirm-delete" class="btn btn-danger">Confirmar</button>
                <button type="button" id="modal-cancel-delete" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    {# NUEVO Modal de Confirmación para Transacción #}
    <div id="delete-transaction-confirm-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h4>Confirmar Eliminación</h4>
            <p>¿Estás seguro de que quieres eliminar esta transacción completa y todos sus recibos asociados?</p>
            <div class="modal-buttons">
                <a href="{% url 'transaction_delete' object.pk %}" class="btn btn-danger">Confirmar Eliminación</a>
                <button type="button" class="btn btn-secondary" id="modal-cancel-delete-transaction">Cancelar</button>
            </div>
        </div>
    </div>

    <template id="empty-form-template">
        <div class="receipt-form-instance" id="receipt-form-__prefix__">
            <h5>Nuevo Recibo</h5>
            <div class="receipt-form-fields">
                <div class="receipt-field">
                    {{ formset.empty_form.origen_transaccion.label_tag }}
                    {{ formset.empty_form.origen_transaccion }}
                </div>
                <div class="receipt-field">
                    {{ formset.empty_form.fecha.label_tag }}
                    {{ formset.empty_form.fecha }}
                </div>
                <div class="receipt-field">{{ formset.empty_form.hora.label_tag }}{{ formset.empty_form.hora }}</div>
                <div class="receipt-field">{{ formset.empty_form.comprobante.label_tag }}{{ formset.empty_form.comprobante }}</div>
                <div class="receipt-field">{{ formset.empty_form.banco_llegada.label_tag }}{{ formset.empty_form.banco_llegada }}</div>
                <div class="receipt-field">{{ formset.empty_form.valor.label_tag }}{{ formset.empty_form.valor }}</div>
                <div class="receipt-delete-wrapper">
                    {% if formset.can_delete %}
                        <div class="delete-checkbox" style="display: none;">{{ formset.empty_form.DELETE }}</div>
                        <button type="button" class="btn btn-danger btn-delete-receipt">Eliminar</button>
                        <button type="button" class="btn btn-secondary btn-undo-delete" style="display: none;">Deshacer</button>
                    {% endif %}
                </div>
            </div>
            {{ formset.empty_form.id }}
        </div>
    </template>

    <style>
        .transaction-form-table {
            width: 100%; margin-bottom: 20px; border-collapse: collapse;
        }
        .transaction-form-table th, .transaction-form-table td {
            padding: 12px; vertical-align: top; border-top: 1px solid #dee2e6;
        }
        .transaction-form-table th {
            text-align: left; width: 20%; font-weight: bold;
        }
        .transaction-form-table input, .transaction-form-table select, .transaction-form-table textarea {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .transaction-form-table .errorlist {
            color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 4px; padding: 10px; margin: 5px 0 0 0; list-style-type: none;
        }

        .receipt-form-instance {
            border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 5px; background-color: #f9f9f9; transition: background-color 0.3s ease;
        }
        .receipt-form-fields {
            display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-start;
        }
        .receipt-field {
            display: flex; flex-direction: column; flex: 1; min-width: 150px;
        }
        .receipt-field label {
            font-weight: bold; margin-bottom: 5px;
        }
        .receipt-field input, .receipt-field select {
            width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .receipt-delete-wrapper {
            flex: 0 0 100px; display: flex; align-items: flex-end; padding-bottom: 8px;
        }

        .receipt-form-instance.marked-for-deletion {
            background-color: #f8d7da;
            opacity: 0.6;
        }
        .receipt-form-instance.marked-for-deletion input, .receipt-form-instance.marked-for-deletion select {
            text-decoration: line-through;
        }

        .receipt-form-instance.has-errors { border-color: red; background-color: #ffebeb; }
        .non-field-errors { color: red; font-weight: bold; margin-bottom: 10px; }
        .errorlist { color: red; margin: 5px 0 0 0; padding: 0; list-style-type: none; }
        #add-receipt-btn { margin-top: 10px; padding: 8px 15px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #add-receipt-btn:hover { background-color: #218838; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-danger:hover { background-color: #c82333; }

        /* Modal Styles */
        .modal { position: fixed; z-index: 1050; left: 0; top: 0; width: 100%; height: 100%; overflow: hidden; outline: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; }
        .modal-content { position: relative; background-color: #fefefe; padding: 20px; border: 1px solid #888; width: auto; max-width: 500px; border-radius: 8px; text-align: center; }
        .modal-buttons { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; }
    </style>

    {# --- INICIO: NUEVAS CLASES CSS PARA COLORES --- #}
    <style>
        .bg-verde {
            background-color: #28a745 !important; /* Verde éxito */
            color: white;
        }
        .bg-rojo {
            background-color: #dc3545 !important; /* Rojo peligro */
            color: white;
        }
        .bg-amarillo {
            background-color: #ffc107 !important; /* Amarillo advertencia */
            color: black;
        }
    </style>
    {# --- FIN: NUEVAS CLASES CSS PARA COLORES --- #}

    <script>
    // Usamos jQuery para el autocompletado
    document.addEventListener('DOMContentLoaded', function() {
        // --- LÓGICA PARA SALDO DE CLIENTE (NUEVA) ---
        const clientSelect = document.getElementById('id_cliente');
        const balanceContainer = document.getElementById('client-balance-container');
        const balanceDisplay = document.getElementById('client-balance-display');

        function updateBalance(clientId) {
            if (!clientId) {
                if(balanceContainer) balanceContainer.style.display = 'none';
                return;
            }

            fetch(`/ajax/get_client_balance/?client_id=${clientId}`)
                .then(response => response.json())
                .then(data => {
                    if (balanceContainer && balanceDisplay && data.balance !== undefined) {
                        const balanceValue = parseFloat(data.balance.replace(/,/g, ''));
                        if (balanceValue > 0) {
                            balanceDisplay.textContent = `Saldo a favor: $${data.balance}`;
                            balanceContainer.style.display = 'block';
                        } else {
                            balanceContainer.style.display = 'none';
                        }
                    } else {
                       if(balanceContainer) balanceContainer.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching client balance:', error);
                    if(balanceContainer) balanceContainer.style.display = 'none';
                });
        }

        if (clientSelect) {
            // Al cargar la página, verificar si ya hay un cliente seleccionado
            if (clientSelect.value) {
                updateBalance(clientSelect.value);
            }
            // Al cambiar la selección del cliente
            clientSelect.addEventListener('change', function() {
                updateBalance(this.value);
            });
        }
        // --- FIN LÓGICA SALDO CLIENTE ---

        const formsetContainer = document.getElementById('formset-container');
        const addReceiptBtn = document.getElementById('add-receipt-btn');
        const totalForms = document.querySelector('#id_receipts-TOTAL_FORMS');
        const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
        
        // Modal elements
        const modal = document.getElementById('delete-confirm-modal');
        const closeModal = modal.querySelector('.close-button');
        const confirmDeleteBtn = document.getElementById('modal-confirm-delete');
        const cancelDeleteBtn = document.getElementById('modal-cancel-delete');
        let formToMarkForDeletion = null;

        function showModal(formInstance) {
            formToMarkForDeletion = formInstance;
            modal.style.display = 'flex';
        }

        function hideModal() {
            formToMarkForDeletion = null;
            modal.style.display = 'none';
        }

        function markForDeletion(formInstance) {
            const deleteCheckbox = formInstance.querySelector('[id$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = true;
                formInstance.classList.add('marked-for-deletion');
                formInstance.querySelector('.btn-delete-receipt').style.display = 'none';
                formInstance.querySelector('.btn-undo-delete').style.display = 'inline-block';
            }
        }

        function undoMarkForDeletion(formInstance) {
            const deleteCheckbox = formInstance.querySelector('[id$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = false;
                formInstance.classList.remove('marked-for-deletion');
                formInstance.querySelector('.btn-delete-receipt').style.display = 'inline-block';
                formInstance.querySelector('.btn-undo-delete').style.display = 'none';
            }
        }

        // Event listeners for modal buttons
        confirmDeleteBtn.addEventListener('click', function() {
            if (formToMarkForDeletion) {
                markForDeletion(formToMarkForDeletion);
            }
            hideModal();
        });

        cancelDeleteBtn.addEventListener('click', hideModal);
        closeModal.addEventListener('click', hideModal);
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                hideModal();
            }
        });

        // Event delegation for delete and undo buttons
        formsetContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('btn-delete-receipt')) {
                const formInstance = event.target.closest('.receipt-form-instance');
                showModal(formInstance);
            }
            if (event.target.classList.contains('btn-undo-delete')) {
                const formInstance = event.target.closest('.receipt-form-instance');
                undoMarkForDeletion(formInstance);
            }
        });

        // Add new form
        if(addReceiptBtn) {
            addReceiptBtn.addEventListener('click', function() {
                const formIndex = totalForms.value;
                const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, formIndex);
                formsetContainer.insertAdjacentHTML('beforeend', newFormHtml);
                totalForms.value = parseInt(formIndex) + 1;
            });
        }

        // --- CÓDIGO PARA CALCULAR FECHA EFECTIVA ---
        const receiptFormsetContainer = document.getElementById('formset-container');
        if (receiptFormsetContainer) {
            receiptFormsetContainer.addEventListener('change', (e) => {
                if (e.target.matches('select[name$="-origen_transaccion"]') || e.target.matches('input[name$="-fecha"]')) {
                    const formPrefix = e.target.name.match(/(receipts-\d+)-/)?.[1] || e.target.name.match(/(form-\d+)-/)?.[1];
                    if (!formPrefix) return;

                    const formNum = formPrefix.split('-')[1];

                    const origenSelect = document.querySelector(`#id_${formPrefix}-origen_transaccion`);
                    const fechaInput = document.querySelector(`#id_${formPrefix}-fecha`);
                    const messageSpan = document.querySelector(`#effective-date-message-${formPrefix}`);

                    if (!origenSelect || !fechaInput || !messageSpan) return;

                    const origenId = origenSelect.value;
                    const fecha = fechaInput.value;

                    if (origenId && fecha) {
                        const url = `{% url 'get_effective_date' %}?origen_id=${origenId}&start_date=${fecha}`;
                        fetch(url)
                            .then(response => response.json())
                            .then(data => {
                                messageSpan.textContent = data.message || '';
                            })
                            .catch(error => console.error('Error:', error));
                    } else {
                        messageSpan.textContent = '';
                    }
                }
            });
        }



        // --- NUEVO: Lógica para el modal de eliminación de transacción ---
        const deleteTransactionModal = document.getElementById('delete-transaction-confirm-modal');
        const openDeleteTransactionModalBtn = document.getElementById('btn-delete-transaction');
        const closeDeleteTransactionModalBtn = deleteTransactionModal.querySelector('.close-button');
        const cancelDeleteTransactionModalBtn = document.getElementById('modal-cancel-delete-transaction');

        if(openDeleteTransactionModalBtn) {
            openDeleteTransactionModalBtn.addEventListener('click', function() {
                deleteTransactionModal.style.display = 'flex';
            });
        }

        const closeTxModal = () => deleteTransactionModal.style.display = 'none';

        if(closeDeleteTransactionModalBtn) {
            closeDeleteTransactionModalBtn.addEventListener('click', closeTxModal);
        }
        if(cancelDeleteTransactionModalBtn) {
            cancelDeleteTransactionModalBtn.addEventListener('click', closeTxModal);
        }

        window.addEventListener('click', function(event) {
            if (event.target == deleteTransactionModal) {
                closeTxModal();
            }
        });

        // --- LÓGICA DE CÁLCULO DE TOTALES ---
        const expectedAmountInput = document.getElementById('id_expected_amount');
        const totalReceiptsAmountOutput = document.getElementById('id_total_receipts_amount');
        const differenceOutput = document.getElementById('id_difference');

        function updateTotals() {
            const parseCustomFloat = (str) => {
                if (!str) return 0;
                const cleaned = str.toString().replace(/,/g, '');
                return parseFloat(cleaned) || 0;
            };

            let totalReceipts = 0;
            const valorInputs = formsetContainer.querySelectorAll('input[name$="-valor"]');

            valorInputs.forEach(input => {
                const formInstance = input.closest('.receipt-form-instance');
                if (!formInstance) return;

                const isDeleted = formInstance.querySelector('input[type="checkbox"][name$="-DELETE"]')?.checked;
                const isHidden = formInstance.style.display === 'none';

                if (!isDeleted && !isHidden) {
                    const value = parseCustomFloat(input.value);
                    totalReceipts += value;
                }
            });

            const expected = parseCustomFloat(expectedAmountInput.value);
            const difference = expected - totalReceipts;

            const numberFormatOptions = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
            totalReceiptsAmountOutput.value = totalReceipts.toLocaleString('en-US', numberFormatOptions);
            differenceOutput.value = difference.toLocaleString('en-US', numberFormatOptions);

            differenceOutput.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-white', 'text-dark');

            if (difference < -0.001) {
                differenceOutput.classList.add('bg-warning', 'text-dark');
            } else if (difference > 0.001) {
                differenceOutput.classList.add('bg-danger', 'text-white');
            } else {
                differenceOutput.classList.add('bg-success', 'text-white');
            }
        }

        function formatNumberInput(input) {
            if (!input || !input.value) {
                updateTotals();0
                return;
            }
            let value = input.value.trim();
            const numericValue = parseFloat(value.replace(/,/g, ''));
            if (isNaN(numericValue)) {
                updateTotals();
                return;
            }
            const numberFormatOptions = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
            input.value = numericValue.toLocaleString('en-US', numberFormatOptions);
            updateTotals();
        }

    function handleTotalsUpdate(e) {
        const target = e.target;
        if (target && (target.matches('input[name$="-valor"]') || target.id === 'id_expected_amount')) {
            let currentValue = target.value;

            // Permitir signo negativo solo al inicio y dígitos, puntos o comas
            const sanitizedValue = currentValue
                .replace(/(?!^)-/g, '')  // elimina guiones que no estén al inicio
                .replace(/[^0-9.,-]/g, ''); // permite números, punto, coma y el guion inicial

            if (currentValue !== sanitizedValue) {
                target.value = sanitizedValue;
            }

            updateTotals();
        }
    }

        function handleFormatting(e) {
            const target = e.target;
            if (target && (target.matches('input[name$="-valor"]') || target.id === 'id_expected_amount')) {
                formatNumberInput(target);
            }
        }

        if (expectedAmountInput) {
            expectedAmountInput.addEventListener('input', handleTotalsUpdate);
            expectedAmountInput.addEventListener('blur', handleFormatting);
        }

        formsetContainer.addEventListener('input', handleTotalsUpdate);
        formsetContainer.addEventListener('blur', handleFormatting, true);

        const mainForm = document.getElementById('transaction-form');
        if (mainForm) {
            mainForm.addEventListener('submit', function() {
                if (expectedAmountInput && expectedAmountInput.value) {
                    expectedAmountInput.value = expectedAmountInput.value.replace(/,/g, '');
                }
                const valorInputs = formsetContainer.querySelectorAll('input[name$="-valor"]');
                valorInputs.forEach(function(input) {
                    if (input.value) {
                        input.value = input.value.replace(/,/g, '');
                    }
                });
            });
        }

        updateTotals();
    });
    </script>

    <script>
    // Usamos $(document).ready() que es el equivalente de jQuery a DOMContentLoaded
    $(document).ready(function() {
        // --- LÓGICA DE AUTOCOMPLETADO PARA CLIENTE ---
        const clientSearchInput = $("#id_client_search");
        const clientIdHiddenInput = $("#id_cliente_id");

        clientSearchInput.autocomplete({
            source: "{% url 'client_search_ajax' %}",
            minLength: 2,
            select: function(event, ui) {
                clientIdHiddenInput.val(ui.item.id).trigger('change'); // Asignar ID y disparar 'change'
                clientSearchInput.val(ui.item.label);
                updateBalance(ui.item.id); // Actualizar saldo al seleccionar
                return false;
            },
            focus: function(event, ui) {
                clientSearchInput.val(ui.item.label);
                return false;
            }
        });

        clientSearchInput.on('keyup input', function() {
            if ($(this).val().trim() === '') {
                clientIdHiddenInput.val('').trigger('change'); // Limpiar ID y disparar 'change'
            }
        });

        // --- LÓGICA DE AUTOCOMPLETADO PARA VENDEDOR ---
        const sellerSearchInput = $("#id_seller_search");
        const sellerIdHiddenInput = $("#id_vendedor_id");

        sellerSearchInput.autocomplete({
            source: "{% url 'seller_search_ajax' %}",
            minLength: 2,
            select: function(event, ui) {
                sellerIdHiddenInput.val(ui.item.id);
                sellerSearchInput.val(ui.item.label);
                return false;
            },
            focus: function(event, ui) {
                sellerSearchInput.val(ui.item.label);
                return false;
            }
        });

        sellerSearchInput.on('keyup input', function() {
            if ($(this).val().trim() === '') {
                sellerIdHiddenInput.val('');
            }
        });
    });
    </script>
{% endblock %}
