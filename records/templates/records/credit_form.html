{% extends "records/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
    <h2>{{ title }}</h2>
    {# Agregamos un ID al formulario para interceptar el envío #}
    <form method="post" id="credit-form">
        {% csrf_token %}
        
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Cliente</th>
                            <th>{{ form.origen_transaccion.label }}</th>
                            <th>{{ form.fecha.label }}</th>
                            <th>{{ form.hora.label }}</th>
                            <th>{{ form.comprobante.label }}</th>
                            <th>{{ form.banco_llegada.label }}</th>
                            <th>{{ form.valor.label }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                {{ form.client_search }}
                                {{ form.cliente_id }} {# Campo oculto para el ID del cliente #}
                            </td>
                            <td>{{ form.origen_transaccion }}</td>
                            <td>{{ form.fecha }}</td>
                            <td>{{ form.hora }}</td>
                            <td>{{ form.comprobante }}</td>
                            <td>{{ form.banco_llegada }}</td>
                            <td>
                                {# Django renderiza el input aquí. JS se encargará de darle formato #}
                                {{ form.valor }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="btn-container">
            <button type="submit" class="btn btn-success">Guardar</button>
            <a href="{% url 'credit_list' %}" class="btn btn-danger">Cancelar</a>
        </div>
    </form>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // ==============================================================
    // 1. LÓGICA DE AUTOCOMPLETADO (Tu código original)
    // ==============================================================
    const clientSearchInput = $("#id_client_search");
    const clientIdHiddenInput = $("#id_cliente_id");

    clientSearchInput.autocomplete({
        source: "{% url 'client_search_ajax' %}",
        minLength: 2,
        select: function(event, ui) {
            clientIdHiddenInput.val(ui.item.id);
            clientSearchInput.val(ui.item.label);
            return false;
        },
        focus: function(event, ui) {
            clientSearchInput.val(ui.item.label);
            return false;
        }
    });

    clientSearchInput.on('keyup input', function() {
        if ($(this).val().trim() === '') {
            clientIdHiddenInput.val('');
        }
    });

    // ==============================================================
    // 2. LÓGICA DE FORMATO DE MONEDA (Implementada igual que en transacciones)
    // ==============================================================
    
    // Seleccionamos el input de valor y el formulario
    // Django por defecto genera el id 'id_valor' para el campo 'valor'
    const valorInput = document.getElementById('id_valor'); 
    const creditForm = document.getElementById('credit-form');

    // A. Forzar tipo texto para evitar que el navegador borre las comas
    if (valorInput) {
        valorInput.setAttribute('type', 'text');
        valorInput.setAttribute('autocomplete', 'off');
        valorInput.classList.add('text-end'); // Opcional: alinear a la derecha como es usual en números
    }

    // B. Función para dar formato visual (1,000.00)
    function formatNumberInput(input) {
        if (!input || !input.value) return;

        let value = input.value.trim();
        // Quitamos comas para poder convertir a número
        const numericValue = parseFloat(value.replace(/,/g, ''));
        
        if (isNaN(numericValue)) return;

        // Formateamos estilo US (comas miles, punto decimal)
        const numberFormatOptions = { minimumFractionDigits: 2, maximumFractionDigits: 2 };
        input.value = numericValue.toLocaleString('en-US', numberFormatOptions);
    }

    // C. Listener: Mientras escribe (INPUT) -> Sanitizar caracteres
    if (valorInput) {
        valorInput.addEventListener('input', function(e) {
            let currentValue = e.target.value;
            
            // Permitir solo números y punto decimal (eliminamos letras y otros símbolos)
            const sanitizedValue = currentValue.replace(/[^0-9.]/g, '');

            if (currentValue !== sanitizedValue) {
                e.target.value = sanitizedValue;
            }
        });

        // D. Listener: Al salir de la casilla (BLUR) -> Aplicar formato bonito
        valorInput.addEventListener('blur', function(e) {
            formatNumberInput(e.target);
        });

        // E. Listener: Al entrar a la casilla (FOCUS) -> Quitar formato para editar fácil
        valorInput.addEventListener('focus', function(e) {
            let val = e.target.value;
            if (val) {
                e.target.value = val.replace(/,/g, '');
                e.target.select(); // Seleccionar todo para facilitar sobreescritura
            }
        });
    }

    // ==============================================================
    // 3. LIMPIEZA AL GUARDAR (SUBMIT)
    // ==============================================================
    if (creditForm) {
        creditForm.addEventListener('submit', function() {
            // Antes de enviar, quitamos las comas para que Django reciba un float válido
            if (valorInput && valorInput.value) {
                valorInput.value = valorInput.value.replace(/,/g, '');
            }
        });
    }
});
</script>
{% endblock %}