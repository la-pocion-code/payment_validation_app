<!-- records/templates/records/abono_form.html -->
{% extends "records/base.html" %}
{% load humanize %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
    <h2>{{ title }}</h2>
    <form method="post">
        {% csrf_token %}
        
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>{{ form.origen_transaccion.label }}</th>
                            <th>{{ form.fecha.label }}</th>
                            <th>Cliente</th>
                            <th>{{ form.hora.label }}</th>
                            <th>{{ form.comprobante.label }}</th>
                            <th>{{ form.banco_llegada.label }}</th>
                            <th>{{ form.valor.label }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>{{ form.origen_transaccion }}</td>
                            <td>{{ form.fecha }}</td>
                            <td>
                                {{ form.client_search }}
                                {{ form.cliente_id }} {# Campo oculto para el ID del cliente #}
                            </td>
                            <td>{{ form.hora }}</td>
                            <td>{{ form.comprobante }}</td>
                            <td>{{ form.banco_llegada }}</td>
                            <td>{{ form.valor }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="btn-container">

            <button type="submit" class="btn btn-success">Guardar</button>
            <a href="{% url 'credit_list' %}" class="btn btn-danger">Cancelar</a>
        </div>
    </form>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Seleccionamos los campos del formulario por su ID
    const clientSearchInput = $("#id_client_search");
    const clientIdHiddenInput = $("#id_cliente_id");

    // Inicializamos el widget de autocompletado de jQuery UI
    clientSearchInput.autocomplete({
        // source: define de dónde se obtendrán los datos.
        // En este caso, nuestra nueva URL de Django.
        source: "{% url 'client_search_ajax' %}",
        
        // minLength: número mínimo de caracteres para activar la búsqueda.
        minLength: 2,

        // select: evento que se dispara cuando un usuario selecciona un ítem de la lista.
        select: function(event, ui) {
            // 'ui.item' contiene el objeto JSON del ítem seleccionado ({id: ..., label: ...})
            
            // 1. Asignar el ID del cliente al campo oculto.
            clientIdHiddenInput.val(ui.item.id);
            
            // 2. Asignar el texto (label) al campo visible.
            clientSearchInput.val(ui.item.label);
            
            // 3. Prevenir el comportamiento por defecto del widget, que es
            //    insertar el 'value' del ítem en el input.
            return false;
        },

        // focus: evento que se dispara al pasar el cursor sobre un ítem.
        // Opcional, pero mejora la experiencia de usuario.
        focus: function(event, ui) {
            // Muestra el label en el input mientras se navega por la lista, sin cambiar el valor real.
            clientSearchInput.val(ui.item.label);
            return false;
        }
    });

    // Evento para limpiar el campo oculto si el usuario borra el texto.
    // Esto es crucial para evitar enviar un ID de cliente incorrecto si el usuario
    // borra su selección y no elige una nueva.
    clientSearchInput.on('keyup input', function() {
        if ($(this).val().trim() === '') {
            clientIdHiddenInput.val('');
        }
    });
});
</script>
{% endblock %}
